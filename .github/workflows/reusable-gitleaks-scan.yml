name: Reusable Gitleaks Secret Scan

on:
  workflow_call:
    inputs:
      fail-on-detection:
        description: 'Whether to fail the workflow if secrets are detected'
        required: false
        type: boolean
        default: false
      gitleaks-version:
        description: 'Gitleaks version to use'
        required: false
        type: string
        default: '8.21.2'
    secrets:
      DEFECTDOJO_TOKEN:
        required: true
        description: 'DefectDojo API token for uploading scan results'

jobs:
  gitleaks-scan:
    name: ğŸ” Secret Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“¦ Download Gitleaks
      run: |
        echo "â¬‡ï¸  Downloading Gitleaks v${{ inputs.gitleaks-version }}..."
        wget -q https://github.com/gitleaks/gitleaks/releases/download/v${{ inputs.gitleaks-version }}/gitleaks_${{ inputs.gitleaks-version }}_linux_x64.tar.gz
        tar -xzf gitleaks_${{ inputs.gitleaks-version }}_linux_x64.tar.gz
        chmod +x gitleaks
        ./gitleaks version
        echo "âœ… Gitleaks downloaded and ready"
    
    - name: ğŸ” Run Gitleaks scan
      run: |
        echo "ğŸ” Starting secret scan..."
        ./gitleaks detect \
          --source=. \
          --report-path=gitleaks-report.json \
          --report-format=json \
          --redact \
          --verbose \
          --exit-code=0
        
        if [ -f "gitleaks-report.json" ]; then
          echo "âœ… Scan completed - report generated"
        else
          echo "âŒ Scan failed - no report generated"
          exit 1
        fi
    
    - name: ğŸ“Š Analyze results
      id: analyze
      run: |
        if [ ! -f "gitleaks-report.json" ]; then
          echo "âŒ Report file not found"
          exit 1
        fi
        
        SECRETS_COUNT=$(jq '. | length' gitleaks-report.json)
        echo "secrets_found=$SECRETS_COUNT" >> $GITHUB_OUTPUT
        
        echo "## ğŸ” Gitleaks Secret Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$SECRETS_COUNT" -gt 0 ]; then
          echo "âš ï¸  **Found $SECRETS_COUNT potential secret(s)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detected Secrets (Redacted):" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "[\(.RuleID)] \(.File):\(.StartLine) - \(.Description)"' gitleaks-report.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **No secrets detected**" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ“¤ Upload to DefectDojo
      if: hashFiles('gitleaks-report.json') != ''
      env:
        DEFECTDOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
        DEFECTDOJO_URL: https://demo.defectdojo.org
      run: |
        echo "ğŸ“¤ Uploading scan results to DefectDojo..."
        
        # Get engagement ID or create new one
        PRODUCT_NAME="SecureTaskApi"
        SCAN_TYPE="Gitleaks Scan"
        
        # Upload the scan results
        RESPONSE=$(curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
          -H "Authorization: Token ${DEFECTDOJO_TOKEN}" \
          -H "Content-Type: multipart/form-data" \
          -F "file=@gitleaks-report.json" \
          -F "scan_type=${SCAN_TYPE}" \
          -F "product_name=${PRODUCT_NAME}" \
          -F "engagement_name=GitHub Actions - $(date +%Y-%m-%d)" \
          -F "auto_create_context=true" \
          -F "active=true" \
          -F "verified=false" \
          -F "close_old_findings=false" \
          -F "push_to_jira=false" \
          -F "minimum_severity=Info" \
          -w "\n%{http_code}" -s)
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… Successfully uploaded to DefectDojo"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DefectDojo Integration" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Upload successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Product:** ${PRODUCT_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${DEFECTDOJO_URL}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸  Upload to DefectDojo failed (HTTP ${HTTP_CODE})"
          echo "Response: $BODY"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DefectDojo Integration" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âš ï¸  Upload failed (HTTP ${HTTP_CODE})" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ“¦ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gitleaks-report
        path: gitleaks-report.json
        retention-days: 90
    
    - name: ğŸš¨ Check failure condition
      if: steps.analyze.outputs.secrets_found > 0 && inputs.fail-on-detection
      run: |
        echo "âŒ Failing workflow due to detected secrets"
        exit 1
