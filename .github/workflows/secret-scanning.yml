name: Secret Scanning

on:
  workflow_dispatch:
    inputs:
      fail-on-detection:
        description: 'Fail workflow if secrets are detected'
        required: false
        type: boolean
        default: true
      scan-path:
        description: 'Path to scan (default: entire repo)'
        required: false
        type: string
        default: '.'

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: ðŸ” Secret Detection
    uses: ./.github/workflows/reusable-gitleaks-scan.yml
    permissions:
      contents: read
      security-events: write
    with:
      scan-path: ${{ inputs.scan-path || '.' }}
      fail-on-detection: ${{ inputs.fail-on-detection != false }}
      upload-sarif: true
      gitleaks-version: 'latest'
      artifact-retention-days: 90
  
  report-status:
    name: ðŸ“Š Report Results
    runs-on: ubuntu-latest
    needs: gitleaks
    if: always()
    
    steps:
    - name: ðŸ“‹ Check scan status
      run: |
        echo "## ðŸ” Secret Scanning Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Secrets Found:** ${{ needs.gitleaks.outputs.secrets-found }}" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Status:** ${{ needs.gitleaks.outputs.scan-status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.gitleaks.outputs.secrets-found }}" = "true" ]; then
          echo "âš ï¸  **Action Required:** Secrets were detected in the repository." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the Gitleaks reports in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Check the Security tab for detailed SARIF analysis" >> $GITHUB_STEP_SUMMARY
          echo "3. Rotate any exposed credentials immediately" >> $GITHUB_STEP_SUMMARY
          echo "4. Update your code to remove the secrets" >> $GITHUB_STEP_SUMMARY
          echo "5. Consider using GitHub Secrets or environment variables" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **All Clear:** No secrets detected in the repository." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Scanned with Gitleaks on $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
